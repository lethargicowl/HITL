{% extends "base.html" %}

{% block title %}Dashboard - HITL Platform{% endblock %}

{% block content %}
<header class="dashboard-header">
    <h1>Assigned Projects</h1>
</header>

<div class="projects-grid" id="projectsGrid">
    <p class="loading">Loading projects...</p>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
});

async function loadProjects() {
    const grid = document.getElementById('projectsGrid');

    try {
        const response = await fetch('/api/projects', { credentials: 'same-origin' });
        if (response.status === 401) {
            window.location.href = '/login';
            return;
        }
        const projects = await response.json();

        if (projects.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <p>No projects assigned to you yet.</p>
                    <p>Ask a requester to assign you to a project.</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = projects.map(project => {
            const progress = project.total_rows > 0
                ? Math.round((project.rated_rows / project.total_rows) * 100)
                : 0;

            return `
                <div class="project-card" onclick="window.location.href='/projects/${project.id}/rate'">
                    <h3>${escapeHtml(project.name)}</h3>
                    <p class="project-desc">${escapeHtml(project.description || 'No description')}</p>
                    <div class="project-stats">
                        <span>${project.session_count} dataset(s)</span>
                        <span>${project.rated_rows}/${project.total_rows} rated</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            `;
        }).join('');

    } catch (error) {
        grid.innerHTML = '<p class="error">Failed to load projects</p>';
    }
}
</script>
{% endblock %}
