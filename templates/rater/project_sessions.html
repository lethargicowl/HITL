{% extends "base.html" %}

{% block title %}Project - HITL Platform{% endblock %}

{% block content %}
<div class="project-header">
    <a href="/dashboard" class="back-link">‚Üê Back to Projects</a>
    <h1 id="projectName">Loading...</h1>
    <p class="project-description" id="projectDescription"></p>
</div>

<section class="section-card">
    <h2>Datasets to Rate</h2>
    <div class="sessions-list" id="sessionsList">
        <p class="loading">Loading datasets...</p>
    </div>
</section>
{% endblock %}

{% block scripts %}
<script>
const PROJECT_ID = "{{ project_id }}";

document.addEventListener('DOMContentLoaded', () => {
    loadProject();
});

async function loadProject() {
    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}`, { credentials: 'same-origin' });
        if (response.status === 401) {
            window.location.href = '/login';
            return;
        }
        if (response.status === 404 || response.status === 403) {
            window.location.href = '/dashboard';
            return;
        }
        const project = await response.json();

        document.getElementById('projectName').textContent = project.name;
        document.getElementById('projectDescription').textContent = project.description || '';

        loadSessions();

    } catch (error) {
        console.error('Failed to load project:', error);
    }
}

async function loadSessions() {
    const list = document.getElementById('sessionsList');

    try {
        const response = await fetch(`/api/projects/${PROJECT_ID}/sessions`, { credentials: 'same-origin' });
        const sessions = await response.json();

        if (sessions.length === 0) {
            list.innerHTML = '<p class="empty-hint">No datasets available yet.</p>';
            return;
        }

        list.innerHTML = sessions.map(session => {
            const progress = session.row_count > 0
                ? Math.round((session.rated_count / session.row_count) * 100)
                : 0;

            return `
                <div class="session-item">
                    <div class="session-info">
                        <h4>${escapeHtml(session.name)}</h4>
                        <span class="session-meta">${session.row_count} rows</span>
                    </div>
                    <div class="session-progress">
                        <span>${session.rated_count}/${session.row_count} rated (${progress}%)</span>
                        <div class="progress-bar small">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                    </div>
                    <a href="/rate/${session.id}" class="btn-primary btn-small">Rate Now</a>
                </div>
            `;
        }).join('');

    } catch (error) {
        list.innerHTML = '<p class="error">Failed to load datasets</p>';
    }
}
</script>
{% endblock %}
