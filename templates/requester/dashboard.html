{% extends "base.html" %}

{% block title %}Dashboard - HITL Platform{% endblock %}

{% block content %}
<header class="dashboard-header">
    <h1>My Projects</h1>
    <button class="btn-primary" onclick="showCreateProjectModal()">+ New Project</button>
</header>

<div class="projects-grid" id="projectsGrid">
    <p class="loading">Loading projects...</p>
</div>

<!-- Create Project Modal -->
<div class="modal" id="createProjectModal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Create New Project</h2>
            <button class="modal-close" onclick="hideCreateProjectModal()">&times;</button>
        </div>
        <form id="createProjectForm">
            <div class="form-group">
                <label for="projectName">Project Name</label>
                <input type="text" id="projectName" required>
            </div>
            <div class="form-group">
                <label for="projectDescription">Description (optional)</label>
                <textarea id="projectDescription" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="evaluationType">Evaluation Type</label>
                <select id="evaluationType" onchange="updateEvalConfigUI()">
                    <option value="rating">Rating Scale (1-5 stars)</option>
                    <option value="binary">Binary Choice (Yes/No)</option>
                    <option value="multi_label">Multi-Label (Select multiple)</option>
                    <option value="multi_criteria">Multi-Criteria (Rate on multiple dimensions)</option>
                    <option value="pairwise">Pairwise Comparison (A vs B)</option>
                </select>
            </div>
            <div id="evalConfigSection">
                <!-- Dynamic config UI will be inserted here -->
            </div>
            <div class="form-group">
                <label for="projectInstructions">Instructions for Raters (optional)</label>
                <textarea id="projectInstructions" rows="3" placeholder="Provide guidelines for how raters should evaluate items..."></textarea>
            </div>
            <div class="form-error" id="createError" style="display: none;"></div>
            <div class="modal-actions">
                <button type="button" class="btn-secondary" onclick="hideCreateProjectModal()">Cancel</button>
                <button type="submit" class="btn-primary">Create Project</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    loadProjects();
});

async function loadProjects() {
    const grid = document.getElementById('projectsGrid');

    try {
        const response = await fetch('/api/projects', { credentials: 'same-origin' });
        if (response.status === 401) {
            window.location.href = '/login';
            return;
        }
        const projects = await response.json();

        if (projects.length === 0) {
            grid.innerHTML = `
                <div class="empty-state">
                    <p>No projects yet.</p>
                    <p>Create your first project to get started!</p>
                </div>
            `;
            return;
        }

        grid.innerHTML = projects.map(project => {
            const progress = project.total_rows > 0
                ? Math.round((project.rated_rows / project.total_rows) * 100)
                : 0;
            const date = new Date(project.created_at).toLocaleDateString();

            return `
                <div class="project-card" onclick="window.location.href='/projects/${project.id}'">
                    <h3>${escapeHtml(project.name)}</h3>
                    <p class="project-desc">${escapeHtml(project.description || 'No description')}</p>
                    <div class="project-stats">
                        <span>${project.session_count} dataset(s)</span>
                        <span>${project.rated_rows}/${project.total_rows} rated</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                    <p class="project-date">Created ${date}</p>
                </div>
            `;
        }).join('');

    } catch (error) {
        grid.innerHTML = '<p class="error">Failed to load projects</p>';
    }
}

function showCreateProjectModal() {
    document.getElementById('createProjectModal').style.display = 'flex';
    document.getElementById('projectName').focus();
    updateEvalConfigUI();
}

function hideCreateProjectModal() {
    document.getElementById('createProjectModal').style.display = 'none';
    document.getElementById('createProjectForm').reset();
    document.getElementById('createError').style.display = 'none';
    document.getElementById('evalConfigSection').innerHTML = '';
}

function updateEvalConfigUI() {
    const evalType = document.getElementById('evaluationType').value;
    const configSection = document.getElementById('evalConfigSection');

    if (evalType === 'rating') {
        configSection.innerHTML = `
            <div class="form-row">
                <div class="form-group half">
                    <label for="ratingMin">Min Value</label>
                    <input type="number" id="ratingMin" value="1" min="1" max="10">
                </div>
                <div class="form-group half">
                    <label for="ratingMax">Max Value</label>
                    <input type="number" id="ratingMax" value="5" min="1" max="10">
                </div>
            </div>
        `;
    } else if (evalType === 'binary') {
        configSection.innerHTML = `
            <div class="form-group">
                <label>Binary Options</label>
                <div class="binary-options">
                    <div class="form-row">
                        <input type="text" id="binaryOption1Value" value="yes" placeholder="Value">
                        <input type="text" id="binaryOption1Label" value="Yes" placeholder="Label">
                    </div>
                    <div class="form-row">
                        <input type="text" id="binaryOption2Value" value="no" placeholder="Value">
                        <input type="text" id="binaryOption2Label" value="No" placeholder="Label">
                    </div>
                </div>
            </div>
        `;
    } else if (evalType === 'multi_label') {
        configSection.innerHTML = `
            <div class="form-group">
                <label>Labels (one per line)</label>
                <textarea id="multiLabelOptions" rows="4" placeholder="accurate:Factually Accurate&#10;helpful:Helpful&#10;safe:Safe"></textarea>
                <small>Format: value:Label (e.g., "accurate:Factually Accurate")</small>
            </div>
        `;
    } else if (evalType === 'multi_criteria') {
        configSection.innerHTML = `
            <div class="form-group">
                <label>Criteria (one per line)</label>
                <textarea id="multiCriteriaOptions" rows="4" placeholder="accuracy:Accuracy:1:5&#10;helpfulness:Helpfulness:1:5"></textarea>
                <small>Format: key:Label:min:max (e.g., "accuracy:Accuracy:1:5")</small>
            </div>
        `;
    } else if (evalType === 'pairwise') {
        configSection.innerHTML = `
            <div class="form-group">
                <label>
                    <input type="checkbox" id="pairwiseConfidence" checked>
                    Include confidence levels (slightly/clearly/much better)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="checkbox" id="pairwiseTie" checked>
                    Allow "Tie" option
                </label>
            </div>
            <div class="info-box">
                <strong>CSV Format:</strong> Your dataset should have columns: <code>prompt</code>, <code>response_a</code>, <code>response_b</code>
            </div>
        `;
    } else {
        configSection.innerHTML = '';
    }
}

function buildEvalConfig() {
    const evalType = document.getElementById('evaluationType').value;

    if (evalType === 'rating') {
        const min = parseInt(document.getElementById('ratingMin')?.value || '1');
        const max = parseInt(document.getElementById('ratingMax')?.value || '5');
        return {
            min: min,
            max: max,
            labels: { [min]: "Poor", [max]: "Excellent" }
        };
    } else if (evalType === 'binary') {
        return {
            options: [
                {
                    value: document.getElementById('binaryOption1Value')?.value || 'yes',
                    label: document.getElementById('binaryOption1Label')?.value || 'Yes'
                },
                {
                    value: document.getElementById('binaryOption2Value')?.value || 'no',
                    label: document.getElementById('binaryOption2Label')?.value || 'No'
                }
            ]
        };
    } else if (evalType === 'multi_label') {
        const text = document.getElementById('multiLabelOptions')?.value || '';
        const options = text.split('\n')
            .filter(line => line.trim())
            .map(line => {
                const [value, label] = line.split(':').map(s => s.trim());
                return { value: value || label, label: label || value };
            });
        return {
            options: options.length > 0 ? options : [{ value: 'option1', label: 'Option 1' }],
            min_select: 0,
            max_select: null
        };
    } else if (evalType === 'multi_criteria') {
        const text = document.getElementById('multiCriteriaOptions')?.value || '';
        const criteria = text.split('\n')
            .filter(line => line.trim())
            .map(line => {
                const parts = line.split(':').map(s => s.trim());
                return {
                    key: parts[0] || 'quality',
                    label: parts[1] || parts[0] || 'Quality',
                    min: parseInt(parts[2]) || 1,
                    max: parseInt(parts[3]) || 5
                };
            });
        return {
            criteria: criteria.length > 0 ? criteria : [{ key: 'quality', label: 'Quality', min: 1, max: 5 }]
        };
    } else if (evalType === 'pairwise') {
        return {
            show_confidence: document.getElementById('pairwiseConfidence')?.checked ?? true,
            allow_tie: document.getElementById('pairwiseTie')?.checked ?? true
        };
    }

    return null;
}

document.getElementById('createProjectForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const errorEl = document.getElementById('createError');
    errorEl.style.display = 'none';

    const name = document.getElementById('projectName').value;
    const description = document.getElementById('projectDescription').value || null;
    const evaluation_type = document.getElementById('evaluationType').value;
    const evaluation_config = buildEvalConfig();
    const instructions = document.getElementById('projectInstructions').value || null;

    try {
        const response = await fetch('/api/projects', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                name,
                description,
                evaluation_type,
                evaluation_config,
                instructions
            }),
            credentials: 'same-origin'
        });

        if (!response.ok) {
            const data = await response.json();
            throw new Error(data.detail || 'Failed to create project');
        }

        const project = await response.json();
        window.location.href = `/projects/${project.id}`;

    } catch (error) {
        errorEl.textContent = error.message;
        errorEl.style.display = 'block';
    }
});

// Close modal on outside click
document.getElementById('createProjectModal').addEventListener('click', (e) => {
    if (e.target.id === 'createProjectModal') {
        hideCreateProjectModal();
    }
});
</script>
{% endblock %}
