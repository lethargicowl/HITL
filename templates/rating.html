{% extends "base.html" %}

{% block title %}Rate Session - HITL Platform{% endblock %}

{% block content %}
<div class="container rating-container">
    <header class="rating-header">
        <div class="header-left">
            <a href="/dashboard" id="backLink" class="back-link">‚Üê Back to Project</a>
            <h1><a id="projectName" href="/dashboard">Project</a> / <span id="sessionName">Loading...</span></h1>
        </div>
        <div class="header-right">
            <span id="unsaved-indicator" class="unsaved-indicator" style="display: none;">Unsaved</span>
            <select id="exportFormat" class="export-select">
                <option value="xlsx">Excel (.xlsx)</option>
                <option value="csv">CSV (.csv)</option>
            </select>
            <button class="btn-secondary" id="exportBtn">Export Results</button>
        </div>
    </header>

    <div class="progress-section">
        <div class="progress-info">
            <span id="progressText">0 / 0 rated</span>
            <span id="progressPercent">0%</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <div class="filter-section">
        <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="unrated">Unrated</button>
            <button class="filter-btn" data-filter="rated">Rated</button>
        </div>
        <div class="navigation">
            <button class="nav-btn" id="prevBtn" disabled>‚Üê Previous</button>
            <span id="pageInfo">Row 1 of 1</span>
            <button class="nav-btn" id="nextBtn" disabled>Next ‚Üí</button>
        </div>
    </div>

    <main class="rating-main">
        <div class="row-card" id="rowCard">
            <div class="row-header">
                <span class="row-number" id="rowNumber">Row #1</span>
                <span class="rating-status" id="ratingStatus"></span>
            </div>
            <div class="row-content" id="rowContent">
                <p class="loading">Loading data...</p>
            </div>
        </div>

        <!-- Other Ratings Section -->
        <div class="other-ratings-section">
            <h3>Other Raters</h3>
            <div id="otherRatings">
                <p class="no-other-ratings">No other ratings yet</p>
            </div>
        </div>

        <!-- Instructions Section (collapsible) -->
        <div class="instructions-section" id="instructionsSection" style="display: none;">
            <div class="instructions-header" onclick="toggleInstructions()">
                <h3>Instructions</h3>
                <span class="toggle-icon" id="instructionsToggle">‚ñº</span>
            </div>
            <div class="instructions-content" id="instructionsContent">
            </div>
        </div>

        <div class="rating-section" id="ratingControls">
            <h3>Your Evaluation</h3>

            <!-- Dynamic evaluation form - will be populated based on evaluation_type -->
            <div id="evaluationForm">
                <!-- Rating type (default) -->
                <div class="star-rating" id="starRating">
                    <button class="star" data-value="1">‚òÖ</button>
                    <button class="star" data-value="2">‚òÖ</button>
                    <button class="star" data-value="3">‚òÖ</button>
                    <button class="star" data-value="4">‚òÖ</button>
                    <button class="star" data-value="5">‚òÖ</button>
                </div>
                <div class="rating-labels" id="ratingLabels">
                    <span>Poor</span>
                    <span>Excellent</span>
                </div>
            </div>

            <div class="comment-section">
                <label for="comment">Comment (optional)</label>
                <textarea id="comment" placeholder="Add any notes about this item..."></textarea>
            </div>

            <div class="action-buttons">
                <button class="btn-secondary" id="skipBtn">Skip</button>
                <button class="btn-primary" id="saveBtn" disabled>Save Rating</button>
                <button class="btn-primary" id="saveNextBtn" disabled>Save & Next</button>
            </div>
        </div>
    </main>

    <div class="keyboard-hints" id="keyboardHints">
        <span>Keyboard: 1-5 to rate ‚Ä¢ ‚Üê/‚Üí to navigate ‚Ä¢ Enter to save & next ‚Ä¢ E for examples</span>
    </div>
</div>

<!-- Examples Toggle Button -->
<button class="examples-toggle-btn" id="examplesToggleBtn" onclick="toggleExamplesPanel()" style="display: none;">
    üìã
    <span class="badge" id="examplesBadge">0</span>
</button>

<!-- Examples Side Panel -->
<div class="examples-panel" id="examplesPanel">
    <div class="examples-panel-header">
        <h3>Annotation Examples</h3>
        <button class="examples-panel-close" onclick="toggleExamplesPanel()">&times;</button>
    </div>
    <div class="examples-panel-content" id="examplesPanelContent">
        <p class="loading">Loading examples...</p>
    </div>
    <div class="examples-hint">Press E to toggle this panel</div>
</div>

<script>
    const SESSION_ID = "{{ session_id }}";
    let annotationExamples = [];

    document.addEventListener('DOMContentLoaded', () => {
        initRating(SESSION_ID);
    });

    // Examples Panel Functions
    function toggleExamplesPanel() {
        const panel = document.getElementById('examplesPanel');
        panel.classList.toggle('open');
    }

    async function loadAnnotationExamples(projectId) {
        try {
            const response = await fetch(`/api/projects/${projectId}/examples`, { credentials: 'same-origin' });
            if (!response.ok) return;

            annotationExamples = await response.json();

            const toggleBtn = document.getElementById('examplesToggleBtn');
            const badge = document.getElementById('examplesBadge');

            if (annotationExamples.length > 0) {
                toggleBtn.style.display = 'flex';
                badge.textContent = annotationExamples.length;
                renderExamplesPanel();
            }
        } catch (error) {
            console.error('Failed to load examples:', error);
        }
    }

    function renderExamplesPanel() {
        const container = document.getElementById('examplesPanelContent');

        if (annotationExamples.length === 0) {
            container.innerHTML = '<p class="empty-hint">No examples available for this project.</p>';
            return;
        }

        container.innerHTML = annotationExamples.map(ex => `
            <div class="example-card ${ex.is_positive ? '' : 'negative'}">
                <div class="example-card-header">
                    <span class="example-card-title">${escapeHtml(ex.title)}</span>
                    <span class="example-card-type">${ex.is_positive ? '‚úì Good' : '‚úó Bad'}</span>
                </div>
                <div class="example-card-content">
                    ${Object.entries(ex.content).map(([key, value]) => `
                        <div class="field-label">${escapeHtml(key)}</div>
                        <div class="field-value">${escapeHtml(String(value))}</div>
                    `).join('')}
                </div>
                <div class="example-card-response">
                    <strong>Expected Response:</strong>
                    ${formatExampleResponse(ex.example_response)}
                </div>
                ${ex.explanation ? `<div class="example-card-explanation">${escapeHtml(ex.explanation)}</div>` : ''}
            </div>
        `).join('');
    }

    function formatExampleResponse(response) {
        if (typeof response === 'object') {
            // Multi-question or structured response
            return Object.entries(response).map(([key, val]) => {
                if (typeof val === 'object' && val.value !== undefined) {
                    return `<div>${escapeHtml(key)}: <strong>${escapeHtml(String(val.value))}</strong></div>`;
                }
                return `<div>${escapeHtml(key)}: <strong>${escapeHtml(String(val))}</strong></div>`;
            }).join('');
        }
        return escapeHtml(String(response));
    }

    // Add keyboard shortcut for examples panel
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        if (e.key === 'e' || e.key === 'E') {
            if (annotationExamples.length > 0) {
                toggleExamplesPanel();
            }
        }
    });
</script>
{% endblock %}
